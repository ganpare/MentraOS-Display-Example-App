# ボタンリファレンス

このドキュメントでは、各画面のGUIボタンとその機能、およびBluetoothコントローラーとの連携について説明します。

## 📋 目次

- [テキストリーダー画面](#テキストリーダー画面)
- [音声プレーヤー画面](#音声プレーヤー画面)
- [設定画面](#設定画面)
- [Bluetoothコントローラー連携](#bluetoothコントローラー連携)

---

## 📄 テキストリーダー画面

テキストファイルを読み込んで、ページごとに表示する画面です。

### ボタン一覧

| ボタンID | 表示名 | 機能 | アクションID（設定用） |
|---------|--------|------|----------------------|
| `prevBtn` | ← 前へ | 前のページに移動します。最初のページの場合は何も起こりません。 | `text_prevBtn` |
| `nextBtn` | 次へ → | 次のページに移動します。最後のページの場合は何も起こりません。 | `text_nextBtn` |
| `displayBtn` | ARグラスに表示 | 現在のページをARグラスに表示します。ファイルを選択またはテキストを入力後、このボタンを押すと表示が開始されます。 | - |
| `fileInput` | 📁 ファイルを選択 | テキストファイル（.txt, .text, .md, .markdown, .csv）を選択して読み込みます。 | - |
| `textInput` | （テキストエリア） | テキストを直接入力できます。ファイルを選択する代わりに、ここにテキストを入力することも可能です。 | - |

### 機能詳細

#### 前のページ（`prevBtn`）
- **アクションID**: `text_prevBtn`
- **機能**: テキストの前のページに移動します
- **動作**: 
  - 現在のページ番号を1つ減らします
  - ARグラスに前のページの内容を表示します
  - ページ情報を更新します（例：「ページ 3 / 10」）

#### 次のページ（`nextBtn`）
- **アクションID**: `text_nextBtn`
- **機能**: テキストの次のページに移動します
- **動作**:
  - 現在のページ番号を1つ増やします
  - ARグラスに次のページの内容を表示します
  - ページ情報を更新します（例：「ページ 3 / 10」）

#### ARグラスに表示（`displayBtn`）
- **機能**: 選択したファイルまたは入力したテキストを読み込んで、ARグラスに表示します
- **動作**:
  1. ファイルまたはテキストを読み込み
  2. サーバー側でページング処理（TextPager）を初期化
  3. 最初のページをARグラスに表示
  4. ページナビゲーションエリアを表示

---

## 🎵 音声プレーヤー画面

音声ファイルを再生し、字幕を表示する画面です。

### ボタン一覧

| ボタンID | 表示名 | 機能 | アクションID（設定用） |
|---------|--------|------|----------------------|
| `playBtn` | ▶️ 再生 | 音声の再生を開始または再開します。 | `audio_playBtn` |
| `pauseBtn` | ⏸️ 一時停止 | 音声の再生を一時停止します。 | `audio_pauseBtn` |
| `skipForwardBtn` | ⏩ +10秒 | 現在の再生位置から10秒早送りします。 | `audio_skipForwardBtn` |
| `skipBackwardBtn` | ⏪ -10秒 | 現在の再生位置から10秒巻き戻しします。 | `audio_skipBackwardBtn` |
| `nextSubtitleBtn` | ⏭️ 次字幕 | 次の字幕に移動します。 | `audio_nextSubtitleBtn` |
| `prevSubtitleBtn` | ⏮️ 前字幕 | 前の字幕に移動します。 | `audio_prevSubtitleBtn` |
| `repeatSubtitleBtn` | 🔁 リピート | 現在の字幕のリピートモードをON/OFFします。 | `audio_repeatSubtitleBtn` |
| `speedBtn` | ⚡ 1.0x | 再生速度を変更します（1.0x → 1.25x → 1.5x → 1.75x → 2.0x → 1.0x...）。 | `audio_speedBtn` |
| `directoryBtn` | 📁 神威ディレクトリ | 音声ファイルのディレクトリを選択します。 | - |
| `backToDirectoryBtn` | ← ディレクトリに戻る | ファイル一覧からディレクトリ選択画面に戻ります。 | - |
| `monthFilter` | （月のフィルタ） | 月で音声ファイルをフィルタリングします。 | - |
| `speakerFilter` | （話者のフィルタ） | 話者（Luna/Professor）で音声ファイルをフィルタリングします。 | - |

### 機能詳細

#### 再生（`playBtn`）
- **アクションID**: `audio_playBtn`
- **機能**: 音声ファイルの再生を開始または再開します
- **動作**:
  - HTML5 Audio要素の`play()`メソッドを呼び出します
  - 音声が再生されていない場合は再生を開始
  - 一時停止中の場合は再生を再開

#### 一時停止（`pauseBtn`）
- **アクションID**: `audio_pauseBtn`
- **機能**: 音声ファイルの再生を一時停止します
- **動作**:
  - HTML5 Audio要素の`pause()`メソッドを呼び出します
  - 再生中の音声を一時停止します

#### 早送り +10秒（`skipForwardBtn`）
- **アクションID**: `audio_skipForwardBtn`
- **機能**: 現在の再生位置から10秒早送りします
- **動作**:
  - `audioElement.currentTime += 10`を実行
  - 音声ファイルの終わりを超えないように制限

#### 巻き戻し -10秒（`skipBackwardBtn`）
- **アクションID**: `audio_skipBackwardBtn`
- **機能**: 現在の再生位置から10秒巻き戻しします
- **動作**:
  - `audioElement.currentTime -= 10`を実行
  - 0秒未満にならないように制限

#### 次字幕（`nextSubtitleBtn`）
- **アクションID**: `audio_nextSubtitleBtn`
- **機能**: 次の字幕に移動します
- **動作**:
  - 字幕インデックスを1つ増やします
  - 対応する字幕の開始時間にシークします
  - 字幕テキストを表示します

#### 前字幕（`prevSubtitleBtn`）
- **アクションID**: `audio_prevSubtitleBtn`
- **機能**: 前の字幕に移動します
- **動作**:
  - 字幕インデックスを1つ減らします
  - 対応する字幕の開始時間にシークします
  - 字幕テキストを表示します

#### リピート（`repeatSubtitleBtn`）
- **アクションID**: `audio_repeatSubtitleBtn`
- **機能**: 現在の字幕のリピートモードを切り替えます
- **動作**:
  - リピートモードがONの場合、現在の字幕が終了すると自動的にその字幕の開始位置に戻ります
  - サーバー側でリピート状態を管理します

#### 速度変更（`speedBtn`）
- **アクションID**: `audio_speedBtn`
- **機能**: 再生速度を切り替えます（1.0x → 1.25x → 1.5x → 1.75x → 2.0x → 1.0x...）
- **動作**:
  - ボタンを押すたびに、再生速度が順番に切り替わります
  - HTML5 Audio要素の`playbackRate`プロパティを変更します
  - ボタンの表示も更新されます（例：「⚡ 1.5x」）

---

## ⚙️ 設定画面

BluetoothコントローラーのボタンにGUIボタンの機能を割り当てる設定画面です。

### ボタン一覧

| ボタンID | 表示名 | 機能 |
|---------|--------|------|
| `saveSettingsBtn` | 💾 設定を保存 | 設定した内容をサーバーに保存します |
| `resetSettingsBtn` | 🔄 デフォルトに戻す | すべての設定をデフォルト（「なし」）に戻します |

### 設定項目

設定画面では、以下のGUIボタンに対して、Bluetoothコントローラーのボタンを割り当てることができます。

#### テキストリーダー
- **前のページ（`text_prevBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **次のページ（`text_nextBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能

#### 音声プレーヤー
- **再生（`audio_playBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **一時停止（`audio_pauseBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **早送り +10秒（`audio_skipForwardBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **巻き戻し -10秒（`audio_skipBackwardBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **次字幕（`audio_nextSubtitleBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **前字幕（`audio_prevSubtitleBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **リピート（`audio_repeatSubtitleBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能
- **速度変更（`audio_speedBtn`）**: シングルクリックとダブルクリックそれぞれにトリガーを割り当て可能

### 利用可能なトリガー

以下のBluetoothボタンがトリガーとして使用できます：

- **⏯️ 再生/一時停止ボタン（`playpause`）**: 再生/一時停止ボタン（シングル/ダブルクリック）
- **⏭️ 次の曲ボタン（`nexttrack`）**: 次の曲ボタン（シングル/ダブルクリック）
- **⏮️ 前の曲ボタン（`prevtrack`）**: 前の曲ボタン（シングル/ダブルクリック）
- **なし（`none`）**: トリガーを割り当てない

---

## 🎮 Bluetoothコントローラー連携

### 動作の流れ

1. **Bluetoothボタンが押される**
   - iOS側の`MediaControlManager`がBluetoothメディアコントローラーイベントを検出
   - イベントタイプ（`playpause`、`nexttrack`、`prevtrack`）を識別

2. **React Native層で処理**
   - `MantleBridge.tsx`がイベントを受信
   - ダブルクリック検出（300ms以内の連続クリック）
   - `GlobalEventEmitter`でイベントを発火

3. **WebView層で処理**
   - `webview.tsx`がイベントを受信
   - JavaScriptをWebViewに注入して`mentraMediaControl`イベントを発火

4. **WebView内のJavaScriptで処理**
   - `mediaControlHandler.js`がイベントを受信
   - ユーザー設定を読み込み
   - トリガー（Bluetoothボタン + シングル/ダブルクリック）からアクション（GUIボタンID）を逆引き
   - 対応するGUIボタンの`click()`を呼び出す

5. **GUIボタンの機能が実行される**
   - 既存のGUIボタンのイベントハンドラーが実行される
   - テキストリーダーのページング、音声プレーヤーの制御などが実行される

### 設定例

#### 例1: テキストリーダーを操作する設定
- **前のページ（`text_prevBtn`）**:
  - シングルクリック: `prevtrack`（前の曲ボタン）
  - ダブルクリック: `none`（なし）
- **次のページ（`text_nextBtn`）**:
  - シングルクリック: `nexttrack`（次の曲ボタン）
  - ダブルクリック: `none`（なし）

この設定により：
- 前の曲ボタンを1回押す → 前のページに移動
- 次の曲ボタンを1回押す → 次のページに移動

#### 例2: 音声プレーヤーを操作する設定
- **再生（`audio_playBtn`）**:
  - シングルクリック: `playpause`（再生/一時停止ボタン）
  - ダブルクリック: `none`（なし）
- **一時停止（`audio_pauseBtn`）**:
  - シングルクリック: `none`（なし）
  - ダブルクリック: `playpause`（再生/一時停止ボタン）

この設定により：
- 再生/一時停止ボタンを1回押す → 再生
- 再生/一時停止ボタンを2回連続で押す（ダブルクリック）→ 一時停止

#### 例3: 複数の機能を1つのボタンに割り当て
- **早送り（`audio_skipForwardBtn`）**:
  - シングルクリック: `nexttrack`（次の曲ボタン）
  - ダブルクリック: `none`（なし）
- **巻き戻し（`audio_skipBackwardBtn`）**:
  - シングルクリック: `prevtrack`（前の曲ボタン）
  - ダブルクリック: `none`（なし）

この設定により：
- 次の曲ボタンを1回押す → 10秒早送り
- 前の曲ボタンを1回押す → 10秒巻き戻し

### 注意事項

1. **同じトリガーを複数のアクションに割り当てた場合**
   - 最後に設定したアクションが優先されます
   - 1つのトリガーには1つのアクションのみが実行されます

2. **設定の保存**
   - 「💾 設定を保存」ボタンを押すまで、設定は保存されません
   - 設定はユーザーごとに保存されます（`data/settings/{userId}.json`）

3. **設定の適用**
   - 設定を保存すると、すぐに反映されます
   - ページをリロードする必要はありません

4. **デフォルト設定**
   - 初期状態では、すべてのアクションが「なし」に設定されています
   - 「🔄 デフォルトに戻す」ボタンで、すべての設定を「なし」に戻せます

---

## 🔧 技術的な詳細

### アクションID → DOM要素IDのマッピング

設定画面で使用するアクションIDと、実際のDOM要素IDの対応関係：

```javascript
{
  'text_prevBtn': 'prevBtn',
  'text_nextBtn': 'nextBtn',
  'audio_playBtn': 'playBtn',
  'audio_pauseBtn': 'pauseBtn',
  'audio_skipForwardBtn': 'skipForwardBtn',
  'audio_skipBackwardBtn': 'skipBackwardBtn',
  'audio_nextSubtitleBtn': 'nextSubtitleBtn',
  'audio_prevSubtitleBtn': 'prevSubtitleBtn',
  'audio_repeatSubtitleBtn': 'repeatSubtitleBtn',
  'audio_speedBtn': 'speedBtn'
}
```

### 設定データ構造

設定は以下の形式で保存されます：

```json
{
  "userId": "user123",
  "actionMappings": {
    "text_prevBtn": {
      "single": { "trigger": "prevtrack" },
      "double": { "trigger": "none" }
    },
    "text_nextBtn": {
      "single": { "trigger": "nexttrack" },
      "double": { "trigger": "none" }
    },
    "audio_playBtn": {
      "single": { "trigger": "playpause" },
      "double": { "trigger": "none" }
    }
  },
  "updatedAt": 1234567890
}
```

---

## 📝 まとめ

- **テキストリーダー画面**: 2つのナビゲーションボタン（前へ/次へ）
- **音声プレーヤー画面**: 8つの制御ボタン（再生、一時停止、早送り、巻き戻し、次字幕、前字幕、リピート、速度変更）
- **設定画面**: 10個のアクションに対して、Bluetoothボタン（3種類 × シングル/ダブル = 6種類のトリガー）を割り当て可能

合計で、3つのBluetoothボタンで最大6種類のトリガーを提供し、10個のGUIボタンに対して柔軟に割り当てることができます。





